import{u as k,A as x,M as z,L as O,U as $,H as M,a as B,b as H}from"./useOSS-4b2adf5e.js";import{d as V,p as j,n as S,C,M as X,aM as Z,ax as g,r as U,o as q,c as F,e as i,j as l,g as o,h as r,z as w,f as s,aN as J}from"./index-17a497b2.js";import{h as K}from"./song-facb0be7.js";const G={class:"flex justify-end"},Q=o("div",{class:"text-sm text-gray-500 font-semibold"},[r(" 支持批量上传mp3文件，生成OSS链接并自动解析出歌曲相关信息，生成新增歌曲信息弹窗 "),o("div",{class:"text-xl font-bold"}," 警告：建议仅在本地开发使用，远程上传严重受带宽影响 ")],-1),W={class:"el-upload__tip p-1 mr-2 !mt-0 border-2 border-red-400 font-semibold"},Y={class:"text-sm"},ee={class:"text-sm"},te={class:"text-sm"},ae=o("div",{class:"text-sm text-gray-500 font-semibold"},[o("div",null,"支持批量上传mp3文件，更改为浏览器上传至OSS生成链接"),o("div",null,"服务器读取并解析出歌曲相关信息，生成新增歌曲信息弹窗"),o("div",{class:"text-xl font-bold"},"推荐使用")],-1),ce=V({name:"MusicUpload",__name:"MusicUpload",emits:["generate-new-songs"],setup(se,{emit:T}){const A={lock:!0,text:"上传解析歌曲中...",background:"rgba(0, 0, 0, 0.7)"},L=j(()=>`上传解析歌曲中... 等待数：${m.value} 成功数：${_.value} 失败数：${v.value}`),m=S(0),_=S(0),v=S(0),d=C(null),N=()=>m.value+=1,u=()=>m.value-=1,y=()=>_.value+=1,f=()=>v.value+=1,p=C([]),E=e=>{const n=B(e);return n&&N(),n},I=e=>{u(),e.code===J.OK?(y(),p.value.push(...e.data)):(f(),g(e.msg,{type:"error"}))},P=e=>{u(),f(),g(e.message,{type:"error"})},{client:b,downloadPrefix:R}=k(),h=C([]);async function D(e){if(b.value!=null){const n=e.file.name,c=`${Date.now()}-${n}`;try{let a="";if(e.file.size>=H){const t=await b.value.multipartUpload(`/music/${c}`,e.file,{});t.name&&(t==null?void 0:t.res.status)===200&&(a=R.value+t.name)}else{const t=await b.value.put(`/music/${c}`,e.file);t.name&&(t==null?void 0:t.res.status)===200&&(a=t.url)}a.length>0?(h.value.push({ossPath:a,filename:n}),u(),y()):(u(),f())}catch{u(),f()}}else u(),f(),g("获取阿里云OSS实例失败，请刷新后重试",{type:"error"})}return X(m,async(e,n)=>{if(e>0&&(d.value===null&&(d.value=Z.service(A)),d.value.setText(L.value)),n===0&&(h.value=[],p.value=[]),e===0){d.value.close(),d.value=null;const c=_.value,a=v.value;g(`上传解析已完成，成功${c}个，失败${a}个`),_.value=0,v.value=0,h.value.length>0&&(p.value=await Promise.all(h.value.map(t=>K(t)))),p.value.length>0&&T("generate-new-songs",p.value)}}),(e,n)=>{const c=U("el-button"),a=U("el-tooltip"),t=U("el-upload");return q(),F("div",G,[i(t,{class:"flex flex-row-reverse items-center mb-4",action:s($),headers:s(M),"show-file-list":!1,multiple:"",accept:s(x),limit:s(O),"before-upload":E,"on-success":I,"on-error":P},{tip:l(()=>[o("div",W,[r(" 格式限制: "),o("span",Y,w(s(x)),1),r("; 大小限制："),o("span",ee,w(s(z)),1),r("; 数量限制："),o("span",te,w(s(O)),1)])]),default:l(()=>[i(a,{effect:"light",placement:"bottom",enterable:!1},{content:l(()=>[Q]),default:l(()=>[i(c,{type:"primary"},{default:l(()=>[r("智能上传解析歌曲")]),_:1})]),_:1})]),_:1},8,["action","headers","accept","limit"]),i(t,{class:"ml-2",multiple:"",action:s($),headers:s(M),"show-file-list":!1,accept:s(x),"before-upload":E,"http-request":D},{default:l(()=>[i(a,{effect:"light",placement:"bottom",enterable:!1},{content:l(()=>[ae]),default:l(()=>[i(c,{type:"primary"},{default:l(()=>[r("智能上传解析歌曲（新）")]),_:1})]),_:1})]),_:1},8,["action","headers","accept"])])}}});export{ce as _};
