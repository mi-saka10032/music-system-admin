import{u as Fe,a as I,e as Le,f as Pe,h as De,i as Ue,j as Z,k as Ae}from"./song-3431cc8a.js";import{u as Me,a as Be,b as Oe,c as Re}from"./useDelete-60b50bf2.js";import{g as $e}from"./singer-edb6f20a.js";import{g as Ve}from"./album-c798d7d5.js";import{d as te,aI as ze,aJ as We,n as $,C as G,p as q,M as Ee,aK as qe,ax as W,r as f,o as ne,i as je,j as A,g as B,h as O,z as Q,e as t,aL as Qe,t as ae,a6 as oe,aM as He,aN as Xe,Y as D,ar as U,aO as Je,aP as Ke,aQ as Ze,aR as Ge,aS as Ye,aT as es,at as M,c as ss,f as S,aU as ts}from"./index-7abcff81.js";import{e as H}from"./mitt-7f99bbc0.js";var R=(i=>(i[i.Start=0]="Start",i[i.BasicAnalysis=1]="BasicAnalysis",i[i.OSS=2]="OSS",i[i.DetailAnalysis=3]="DetailAnalysis",i))(R||{});const E={0:"上传完成，解析开始",1:"基础信息解析完成",2:"OSS上传完成",3:"详细信息解析完成"},ns=B("p",{class:"text-sm text-gray-500 font-semibold"}," 支持批量上传mp3文件，生成OSS链接并自动解析出歌曲相关信息，生成新增歌曲信息弹窗 ",-1),as="/api/song/upload",os=256*1024*1024,Y="256MB",ee=".mp3",se=10,ls=te({name:"MusicUpload",__name:"index",emits:["generate-new-songs"],setup(i,{emit:y}){var z;const a={Authorization:ze(((z=We())==null?void 0:z.accessToken)||"")},u=$(0),o=$(0),c=$(0),m=G(null),x=()=>u.value+=1,N=()=>u.value-=1,T=()=>o.value+=1,v=()=>c.value+=1,h=G([]),r=d=>{const{name:L,size:l}=d;return l>os?(W(`${L}文件超出${Y}大小限制，已取消上传`,{type:"error"}),!1):(x(),!0)},w=d=>{N(),d.code===Qe.OK?(T(),h.value.push(...d.data)):(v(),W(d.msg,{type:"error"}))},F=d=>{N(),v(),W(d.message,{type:"error"})},V={lock:!0,text:"上传解析歌曲中...",background:"rgba(0, 0, 0, 0.7)"},_=q(()=>`上传解析歌曲中... 等待数：${u.value} 成功数：${o.value} 失败数：${c.value}`);return Ee(u,(d,L)=>{if(d>0&&(m.value===null&&(m.value=qe.service(V)),m.value.setText(_.value)),L===0&&(h.value=[]),d===0){m.value.close(),m.value=null;const l=o.value,p=c.value;W(`上传解析已完成，成功${l}个，失败${p}个`),o.value=0,c.value=0,h.value.length>0&&y("generate-new-songs",h.value)}}),(d,L)=>{const l=f("el-button"),p=f("el-tooltip"),j=f("el-upload");return ne(),je(j,{class:"flex flex-row-reverse items-center mb-4",action:as,headers:a,"show-file-list":!1,multiple:"",accept:ee,limit:se,"before-upload":r,"on-success":w,"on-error":F},{tip:A(()=>[B("div",{class:"el-upload__tip p-1 mr-2 !mt-0 border-2 border-red-400 font-semibold"},[O(" 格式限制: "),B("span",{class:"text-[14px]"},Q(ee)),O("; 大小限制："),B("span",{class:"text-[14px]"},Q(Y)),O("; 数量限制："),B("span",{class:"text-[14px]"},Q(se))])]),default:A(()=>[t(p,{effect:"light",placement:"bottom",enterable:!1},{content:A(()=>[ns]),default:A(()=>[t(l,{type:"primary"},{default:A(()=>[O("智能上传解析歌曲")]),_:1})]),_:1})]),_:1})}}});function is(i){const y=i,a=$(0),u=$(0);let o=null;const c={block:"start",inline:"center",behavior:"smooth"},m=q(()=>a.value>0),x=q(()=>a.value<u.value-1);function N(){o=document.querySelector(y),o&&m.value&&(a.value-=1,v(a.value))}function T(){o=document.querySelector(y),o&&x.value&&(a.value+=1,v(a.value))}function v(r){o.children[r].scrollIntoView(c)}function h(){a.value=0}return{childrenLength:u,enablePrev:m,enableNext:x,prevTo:N,nextTo:T,resetCurIndex:h}}function rs(i=3e4){const y=`ws://${window.location.host}`;let a=null,u=null,o=0;function c(){window.clearTimeout(u)}function m(){u=window.setTimeout(()=>{a.readyState===1?(a.send("ping"),c(),m()):r()},i)}function x(){c(),m()}function N(){}function T(){++o<=3&&r()}function v(){a&&a.close(),c()}function h(w){const F=w.data;F!=="pong"&&H.emit("websocketMessage",F)}function r(){if(!("WebSocket"in window)){console.warn("当前浏览器不支持Websocket!");return}const w=`/socket/${He()}`;a=new window.WebSocket(y+w),a.onopen=x,a.onclose=N,a.onerror=T,window.onbeforeunload=v,a.onmessage=h,Xe.set("socketId",w)}ae(r),oe(v)}const ps=te({name:"Song",__name:"index",setup(i){const{loading:y,tableColumns:a,tableData:u,pagination:o,checkedIds:c,openLoading:m,closeLoading:x,injectCheckedIds:N,handleCurrentPageChange:T,handlePageSizeChange:v,resetPagination:h}=Fe(),{queryForm:r,queryFormColumns:w,resetQueryForm:F}=Me({songName:"",lyric:"",startPublishTime:null,endPublishTime:null,albumName:"",singerName:""},I().songQueryFormColumns),{createForm:V,createFormColumns:_,resetCreateForm:z,createSuccessMsg:d,batchCreateSuccessMsg:L}=Be({songName:"",duration:0,lyric:"",musicUrl:"",publishTime:null,album:{albumName:"",coverUrl:"",publishTime:null},singer:{singerName:"",coverUrl:""},albumId:null,singerId:null},I().songCreateFormColumns),{updateForm:l,updateFormColumns:p,resetUpdateForm:j,updateSuccessMsg:le}=Oe({id:null,songName:"",duration:0,lyric:"",musicUrl:"",publishTime:null,albumId:null,singerIds:[]},I().songDetailFormColumns),{deleteSuccessMsg:X,deleteNoCheckedMsg:ie}=Re();a.value=I().songTableColumns;const re=q(()=>({songName:r.songName,lyric:r.lyric,startPublishTime:r.startPublishTime,endPublishTime:r.endPublishTime,albumName:r.albumName,singerName:r.singerName,pageNo:o.currentPage,pageSize:o.pageSize})),ue=D({title:"歌曲信息新增",contentRenderer:()=>t(U,{formValue:V,formColumns:_,showButton:!1,isFlex:!1},null),beforeSure:async s=>{await Le(V),d(),s(),C()}}),ce=D({title:"歌曲信息编辑",contentRenderer:()=>t(U,{formValue:l,formColumns:p,showButton:!1,isFlex:!1},null),beforeSure:async s=>{await Pe(l),le(),s(),C()}});async function me(){const b=(await $e({pageNo:1,pageSize:1e3})).list.map(e=>({value:e.id,label:e.singerName}));for(let e=0;e<_.length;e++)if(_[e].prop==="singerId"){_[e].options=b;break}for(let e=0;e<p.length;e++)if(p[e].prop==="singerIds"){p[e].options=b;break}}async function de(){const b=(await Ve({pageNo:1,pageSize:1e3})).list.map(e=>({value:e.id,label:e.albumName}));for(let e=0;e<_.length;e++)if(_[e].prop==="albumId"){_[e].options=b;break}for(let e=0;e<p.length;e++)if(p[e].prop==="albumId"){p[e].options=b;break}}async function C(){m();try{const s=await De(re.value),n=s.list;u.value=n,o.total=s.total}catch{}x()}function fe(){F(),h(),C()}async function ge(s){await Z(s),X(),C()}async function pe(){c.value.length>0?(await Promise.all(c.value.map(s=>Z(s))),X(),C()):ie()}function be(){z(),M(ue)}async function ve(s){var b;j();const n=await Ae(s);l.id=n.id,l.songName=n.songName,l.duration=n.duration,l.lyric=n.lyric,l.musicUrl=n.musicUrl,l.publishTime=n.publishTime,l.albumId=(b=n.album)==null?void 0:b.id,l.singerIds=n.singers.map(e=>e.id),M(ce)}const g=D({newSongs:new Array,formColumns:I().songTemplateCreateFormColumns,albumFormColumns:I().albumDetailFormColumns,singerFormColumns:I().singerFormColumns,isWaiting:!1}),k=D({songLists:new Array,isAlive:!1});function he(){g.newSongs=[],g.isWaiting=!1}function J(){k.songLists=[],k.isAlive=!1}const{childrenLength:Ce,enablePrev:we,enableNext:_e,prevTo:Se,nextTo:ye,resetCurIndex:xe}=is(".outer_form"),K=D({title:"批量新增歌曲信息",openDelay:100,closeOnClickModal:!1,closeOnPressEscape:!1,contentRenderer:()=>t("div",null,[t("div",{class:"outer_form flex overflow-x-scroll"},[g.newSongs.map(s=>t(U,{class:"grow-0 shrink-0 basis-full",formValue:s,formColumns:g.formColumns,showButton:!1,isFlex:!1},{embedAlbum:()=>t(U,{class:"embed_album w-full",formValue:s.album,formColumns:g.albumFormColumns,showButton:!1,isFlex:!1},null),embedSinger:()=>t(U,{class:"embed_singer w-full",formValue:s.singer,formColumns:g.singerFormColumns,showButton:!1,isFlex:!1},null)}))]),g.newSongs.length>1?t("div",{class:"flex justify-center items-center mt-2"},[t(f("el-button"),{icon:Je,circle:!0,disabled:!we.value,onClick:Se},null),t(f("el-button"),{icon:Ke,circle:!0,disabled:!_e.value,onClick:ye},null)]):t("div",null,null)]),beforeSure:async s=>{await Ue(g.newSongs),L(),s(),C()},closeCallBack:()=>{he(),J(),xe()}}),Ne=D({title:"歌曲上传进度",closeOnClickModal:!1,closeOnPressEscape:!1,contentRenderer:()=>t("ul",null,[k.songLists.map((s,n)=>t("li",{key:s.originalName+n,class:"flex items-center"},[t(f("el-tooltip"),{placement:"left",effect:"light",enterable:!1},{default:()=>t("div",{class:"w-48 truncate text-base font-semibold"},[s.originalName,O("：")]),content:()=>t("div",{class:"text-base font-semibold"},[s.originalName])}),t(f("el-steps"),{class:"flex-1",active:s.status,"process-status":"finish","finish-status":"success","align-center":!0},{default:()=>[t(f("el-step"),{title:R[0],description:E[0],icon:Ze},null),t(f("el-step"),{title:R[1],description:E[1],icon:Ge},null),t(f("el-step"),{title:R[2],description:E[2],icon:Ye},null),t(f("el-step"),{title:R[3],description:E[3],icon:es},null)]})]))]),footerRenderer:()=>t("div",null,null),closeCallBack:()=>{g.isWaiting&&(J(),M(K))}});function Te(s){g.newSongs=s,Ce.value=g.newSongs.length,ts.value.length===0?M(K):g.isWaiting=!0}function ke(s){let n;try{n=JSON.parse(s)}catch{}if(!n&&typeof n!="object")return;k.songLists.some(e=>{if(e.originalName===n.originalName)return e.status=n.status+1,!0})||k.songLists.push(n),k.isAlive||(k.isAlive=!0,M(Ne))}return rs(),ae(()=>{C(),me(),de(),H.on("websocketMessage",ke)}),oe(()=>{H.off("websocketMessage")}),(s,n)=>{const b=f("InlineButton"),e=f("pure-table");return ne(),ss("div",null,[t(U,{"form-value":S(r),"form-columns":S(w),"show-button":!0,"is-flex":!0,onQuery:C,onReset:fe,onCreate:be,onDelete:pe},null,8,["form-value","form-columns"]),t(ls,{onGenerateNewSongs:Te}),t(e,{loading:S(y),columns:S(a),data:S(u),pagination:S(o),onSelectionChange:S(N),onPageCurrentChange:n[0]||(n[0]=P=>S(T)(P,C)),onPageSizeChange:n[1]||(n[1]=P=>S(v)(P,C))},{operation:A(({row:P})=>[t(b,{onInlineEdit:Ie=>ve(P.id),onInlineDelete:Ie=>ge(P.id)},null,8,["onInlineEdit","onInlineDelete"])]),_:1},8,["loading","columns","data","pagination","onSelectionChange"])])}}});export{ps as default};
