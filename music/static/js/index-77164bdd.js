import{u as oe}from"./useTable-49b5b1e9.js";import{u as te,a as ne}from"./useDelete-1f82a3fd.js";import{useCreateDialog as ae}from"./useCreateDialog-194b3e6c.js";import{useUpdateDialog as se}from"./useUpdateDialog-1a9d34de.js";import{useBatchTemplateDialog as ie}from"./useBatchTemplateDialog-9636da49.js";import{u as F}from"./music-25eabcb2.js";import{c as re,e as x,f as le}from"./song-1fa23220.js";import{g as ue}from"./singer-2c86cc39.js";import{g as me}from"./album-8abbb620.js";import{t as U,a6 as z,aI as ce,aJ as ge,d as pe,p as de,r as M,o as fe,c as be,e as y,f as r,ar as he,j as we,at as C,aK as Se}from"./index-1e13b2eb.js";import{e as P}from"./mitt-7f99bbc0.js";import{_ as ye}from"./MusicUpload.vue_vue_type_script_setup_true_lang-c2269490.js";import"./resetForm-36ba5b8d.js";import"./useCreate-0d00d5b4.js";import"./OSSUpload.vue_vue_type_script_setup_true_lang-f59c85fc.js";import"./oss-84d83bee.js";import"./uploadConstant-c3ab0c92.js";import"./useUpdate-7bea14f5.js";function Ce(T=3e4){const k=`ws://${window.location.host}`;let n=null,f=null,u=0;function m(){window.clearTimeout(f)}function b(){f=window.setTimeout(()=>{n.readyState===1?(n.send("ping"),m(),b()):a()},T)}function N(){m(),b()}function _(){}function v(){++u<=3&&a()}function h(){n&&n.close(),m()}function D(c){const w=c.data;w!=="pong"&&P.emit("websocketMessage",w)}function a(){if(!("WebSocket"in window)){console.warn("当前浏览器不支持Websocket!");return}const c=`/socket/${ce()}`;n=new window.WebSocket(k+c),n.onopen=N,n.onclose=_,n.onerror=v,window.onbeforeunload=h,n.onmessage=D,ge.set("socketId",c)}U(a),z(h)}const Ae=pe({name:"Song",__name:"index",setup(T){const{loading:k,tableColumns:n,tableData:f,pagination:u,checkedIds:m,openLoading:b,closeLoading:N,injectCheckedIds:_,handleCurrentPageChange:v,handlePageSizeChange:h,resetPagination:D}=oe(),{queryForm:a,queryFormColumns:c,resetQueryForm:w}=te({songName:"",lyric:"",startPublishTime:null,endPublishTime:null,albumName:"",singerName:""},F().songQueryFormColumns),B=de(()=>({songName:a.songName,lyric:a.lyric,startPublishTime:a.startPublishTime,endPublishTime:a.endPublishTime,albumName:a.albumName,singerName:a.singerName,pageNo:u.currentPage,pageSize:u.pageSize}));n.value=F().songTableColumns;async function i(){b();try{const t=await re(B.value),o=t.list;f.value=o,u.total=t.total}catch{}N()}const{createFormColumns:g,createDialog:W,resetCreateForm:$}=ae(i),{updateForm:l,updateFormColumns:p,editDialog:q,resetUpdateForm:A}=se(i),{batchTemplates:I,songProgress:S,batchTemplateSongsDialog:E,progressDialog:Q,childrenLength:R}=ie(i),{deleteSuccessMsg:L,deleteNoCheckedMsg:j}=ne();async function J(){const s=(await ue({pageNo:1,pageSize:1e3})).list.map(e=>({value:e.id,label:e.singerName}));for(let e=0;e<g.length;e++)if(g[e].prop==="singerId"){g[e].options=s;break}for(let e=0;e<p.length;e++)if(p[e].prop==="singerIds"){p[e].options=s;break}}async function O(){const s=(await me({pageNo:1,pageSize:1e3})).list.map(e=>({value:e.id,label:e.albumName}));for(let e=0;e<g.length;e++)if(g[e].prop==="albumId"){g[e].options=s;break}for(let e=0;e<p.length;e++)if(p[e].prop==="albumId"){p[e].options=s;break}}function G(){w(),D(),i()}async function H(t){await x(t),L(),i()}async function K(){m.value.length>0?(await Promise.all(m.value.map(t=>x(t))),L(),i()):j()}function V(){$(),C(W)}async function X(t){var s;A();const o=await le(t);l.id=o.id,l.songName=o.songName,l.duration=o.duration,l.lyric=o.lyric,l.musicUrl=o.musicUrl,l.publishTime=o.publishTime,l.albumId=(s=o.album)==null?void 0:s.id,l.singerIds=o.singers.map(e=>e.id),C(q)}function Y(t){I.newSongs=t,R.value=I.newSongs.length,Se.value.length===0?C(E):I.isWaiting=!0}function Z(t){let o;try{o=JSON.parse(t)}catch{}if(!o&&typeof o!="object")return;S.songLists.some(e=>{if(e.originalName===o.originalName)return e.status=o.status+1,!0})||S.songLists.push(o),S.isAlive||(S.isAlive=!0,C(Q))}return Ce(),U(()=>{i(),J(),O(),P.on("websocketMessage",Z)}),z(()=>{P.off("websocketMessage")}),(t,o)=>{const s=M("InlineButton"),e=M("pure-table");return fe(),be("div",null,[y(he,{"form-value":r(a),"form-columns":r(c),"show-button":!0,"is-flex":!0,onQuery:i,onReset:G,onCreate:V,onDelete:K},null,8,["form-value","form-columns"]),y(ye,{onGenerateNewSongs:Y}),y(e,{loading:r(k),columns:r(n),data:r(f),pagination:r(u),onSelectionChange:r(_),onPageCurrentChange:o[0]||(o[0]=d=>r(v)(d,i)),onPageSizeChange:o[1]||(o[1]=d=>r(h)(d,i))},{operation:we(({row:d})=>[y(s,{onInlineEdit:ee=>X(d.id),onInlineDelete:ee=>H(d.id)},null,8,["onInlineEdit","onInlineDelete"])]),_:1},8,["loading","columns","data","pagination","onSelectionChange"])])}}});export{Ae as default};
