import{A as C,M as B,L as K,U as M,H as $,u as H}from"./uploadConstant-7c8c8e3a.js";import{C as x,n as w,t as V,d as j,p as z,M as X,aM as q,ax as b,r as U,o as F,c as J,e as i,j as o,g as a,h as d,z as k,f as s,aN as Z}from"./index-1bb20c8b.js";import{h as A,i as G}from"./song-de5da4eb.js";function Q(){const T=x(null),_=w("");return V(async()=>{const c=await A();_.value=c.region,T.value=new window.OSS({region:"oss-cn-chengdu",accessKeyId:c.accessKeyId,accessKeySecret:c.accessKeySecret,stsToken:c.stsToken,bucket:c.bucket,refreshSTSToken:async()=>{const f=await A();return{accessKeyId:f.accessKeyId,accessKeySecret:f.accessKeySecret,stsToken:f.stsToken}},refreshSTSTokenInterval:3e5})}),{client:T,downloadPrefix:_}}const W={class:"flex justify-end"},Y=a("div",{class:"text-sm text-gray-500 font-semibold"},[d(" 支持批量上传mp3文件，生成OSS链接并自动解析出歌曲相关信息，生成新增歌曲信息弹窗 "),a("div",{class:"text-xl font-bold"}," 警告：建议仅在本地开发使用，远程上传严重受带宽影响 ")],-1),ee={class:"el-upload__tip p-1 mr-2 !mt-0 border-2 border-red-400 font-semibold"},te={class:"text-sm"},se={class:"text-sm"},ae={class:"text-sm"},oe=a("div",{class:"text-sm text-gray-500 font-semibold"},[a("div",null,"支持批量上传mp3文件，更改为浏览器上传至OSS生成链接"),a("div",null,"服务器读取并解析出歌曲相关信息，生成新增歌曲信息弹窗"),a("div",{class:"text-xl font-bold"},"推荐使用")],-1),ue=j({name:"MusicUpload",__name:"MusicUpload",emits:["generate-new-songs"],setup(T,{emit:_}){const c={lock:!0,text:"上传解析歌曲中...",background:"rgba(0, 0, 0, 0.7)"},f=z(()=>`上传解析歌曲中... 等待数：${h.value} 成功数：${g.value} 失败数：${S.value}`),h=w(0),g=w(0),S=w(0),p=x(null),N=()=>h.value+=1,u=()=>h.value-=1,O=()=>g.value+=1,m=()=>S.value+=1,v=x([]),E=e=>{const l=H(e);return l&&N(),l},P=e=>{u(),e.code===Z.OK?(O(),v.value.push(...e.data)):(m(),b(e.msg,{type:"error"}))},R=e=>{u(),m(),b(e.message,{type:"error"})},{client:I,downloadPrefix:D}=Q(),y=x([]);async function L(e){if(I.value){const l=e.file.name,r=`${Date.now()}-${l}`;try{const t=await I.value.multipartUpload(`/music/${r}`,e.file);let n="";t.name&&(t==null?void 0:t.res.status)===200&&(n=D.value+t.name),n.length>0?(y.value.push({ossPath:n,filename:l}),u(),O()):(u(),m())}catch{u(),m()}}else u(),m(),b("获取阿里云OSS实例失败，请刷新后重试",{type:"error"})}return X(h,async(e,l)=>{if(e>0&&(p.value===null&&(p.value=q.service(c)),p.value.setText(f.value)),l===0&&(y.value=[],v.value=[]),e===0){p.value.close(),p.value=null;const r=g.value,t=S.value;b(`上传解析已完成，成功${r}个，失败${t}个`),g.value=0,S.value=0,y.value.length>0&&(v.value=await Promise.all(y.value.map(n=>G(n)))),v.value.length>0&&_("generate-new-songs",v.value)}}),(e,l)=>{const r=U("el-button"),t=U("el-tooltip"),n=U("el-upload");return F(),J("div",W,[i(n,{class:"flex flex-row-reverse items-center mb-4",action:s(M),headers:s($),"show-file-list":!1,multiple:"",accept:s(C),limit:s(K),"before-upload":E,"on-success":P,"on-error":R},{tip:o(()=>[a("div",ee,[d(" 格式限制: "),a("span",te,k(s(C)),1),d("; 大小限制："),a("span",se,k(s(B)),1),d("; 数量限制："),a("span",ae,k(s(K)),1)])]),default:o(()=>[i(t,{effect:"light",placement:"bottom",enterable:!1},{content:o(()=>[Y]),default:o(()=>[i(r,{type:"primary"},{default:o(()=>[d("智能上传解析歌曲")]),_:1})]),_:1})]),_:1},8,["action","headers","accept","limit"]),i(n,{class:"ml-2",multiple:"",action:s(M),headers:s($),"show-file-list":!1,accept:s(C),"before-upload":E,"http-request":L},{default:o(()=>[i(t,{effect:"light",placement:"bottom",enterable:!1},{content:o(()=>[oe]),default:o(()=>[i(r,{type:"primary"},{default:o(()=>[d("智能上传解析歌曲（新）")]),_:1})]),_:1})]),_:1},8,["action","headers","accept"])])}}});export{ue as _};
